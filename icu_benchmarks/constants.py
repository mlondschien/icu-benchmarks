from pathlib import Path
from typing import Any, Dict

DATA_DIR = Path(__file__).parents[1] / "data"

VARIABLE_REFERENCE_PATH = (
    Path(__file__).parents[1] / "resources" / "variable_reference.tsv"
)

HORIZONS = [8, 24, 72]

DATASETS = [
    "mimic",
    "mimic-metavision",
    "mimic-carevue",
    "miived",
    "miiv",
    "miiv-late",
    "eicu",
    "hirid",
    "aumc",
    "aumc-early",
    "aumc-late",
    "sic",
    "zigong",
    "picdb",
    "nwicu",
]


OUTCOMES = [
    "remaining_los",
    "mortality_at_24h",
    "los_at_24h",
    "decompensation_at_24h",
    "respiratory_failure_at_24h",
    "circulatory_failure_at_8h",
    "kidney_failure_at_48h",
    "log_creatine_in_1h",
    "log_lactate_in_1h",
    "log_lactate_in_8h",
    "log_rel_urine_rate_in_1h",
    "log_rel_urine_rate_in_8h",
    "log_po2",
]

# Approx. number of rows per GB of memory. If all ~1000 columns were float64, this would
# be ~125_000. We get a bit less due to boolean and categorical columns.
OBSERVATIONS_PER_GB = 160_000

TASKS: Dict[str, Dict[str, Any]] = {
    "log_po2": {
        "task": "regression",
        "family": "gaussian",
        "alpha_max": 0.4,
        "n_samples": {
            "mimic": 338189,
            "mimic-metavision": 109443,
            "mimic-carevue": 225484,
            "miived": 0,
            "miiv": 415590,
            "miiv-late": 211551,
            "eicu": 277943,
            "hirid": 203075,
            "aumc": 439735,
            "aumc-early": 208448,
            "aumc-late": 231287,
            "sic": 482286,
            "zigong": 13336,
            "picdb": 0,
            "nwicu": 0,
        },
        "variables": [
            "age",
            "anti_coag_ind",
            "cf_treat_ind",
            "diur_ind",
            "fio2",
            "ins_ind",
            "map",
            "mgcs",
            "o2sat",
            "pco2",
            "peak",
            "peep",
            "resp",
            "sed_ind",
            "sex",
            "supp_o2_vent",
            "temp",
            "tgcs",
        ],
    },
    "remaining_los": {
        "task": "regression",
        "family": "gamma",
        "alpha_max": 0.6,
        "n_samples": {
            "mimic": 4586276,
            "ehrshot": 0,
            "miived": 0,
            "miiv": 7382185,
            "eicu": 12096141,
            "hirid": 1781542,
            "aumc": 1832031,
            "sic": 1858134,
            "zigong": 387493,
            "picdb": 0,
            "mimic-metavision": 1846108,
            "mimic-carevue": 2689494,
            "miiv-late": 3736973,
            "aumc-early": 863355,
            "aumc-late": 968676,
            "nwicu": 2179335,
        },
    },
    "mortality_at_24h": {
        "task": "classification",
        "family": "binomial",
        "alpha_max": 0.07,
        "n_samples": {
            "mimic": 45018,
            "ehrshot": 32890,
            "miived": 0,
            "miiv": 74814,
            "eicu": 132388,
            "hirid": 16611,
            "aumc": 12762,
            "sic": 19486,
            "zigong": 2422,
            "picdb": 0,
            "mimic-metavision": 19544,
            "mimic-carevue": 25007,
            "miiv-late": 36402,
            "aumc-early": 5544,
            "aumc-late": 7218,
            "nwicu": 21566,
        },
    },
    "los_at_24h": {
        "task": "regression",
        "family": "gamma",
        "alpha_max": 0.5,
        "n_samples": {
            "mimic": 45018,
            "ehrshot": 0,
            "miived": 0,
            "miiv": 74814,
            "eicu": 132388,
            "hirid": 16611,
            "aumc": 12762,
            "sic": 19486,
            "zigong": 2422,
            "picdb": 0,
            "mimic-metavision": 19544,
            "mimic-carevue": 25007,
            "miiv-late": 36402,
            "aumc-early": 5544,
            "aumc-late": 7218,
            "nwicu": 21566,
        },
    },
    "decompensation_at_24h": {
        "task": "classification",
        "family": "binomial",
        "alpha_max": 0.025,
        "n_samples": {
            "mimic": 3484186,
            "ehrshot": 3049961,
            "miived": 0,
            "miiv": 5460238,
            "eicu": 12097602,
            "hirid": 1105836,
            "aumc": 1832148,
            "sic": 1381888,
            "zigong": 382308,
            "picdb": 0,
            "mimic-metavision": 1355081,
            "mimic-carevue": 2089759,
            "miiv-late": 2822499,
            "aumc-early": 863397,
            "aumc-late": 968751,
            "nwicu": 2179674,
        },
    },
    "respiratory_failure_at_24h": {
        "task": "classification",
        "family": "binomial",
        "alpha_max": 0.25,
        "n_samples": {
            "mimic": 795094,
            "ehrshot": 72164,
            "miived": 0,
            "miiv": 1013481,
            "eicu": 1584555,
            "hirid": 443957,
            "aumc": 646446,
            "sic": 353134,
            "zigong": 0,
            "picdb": 0,
            "mimic-metavision": 319568,
            "mimic-carevue": 468680,
            "miiv-late": 465963,
            "aumc-early": 373011,
            "aumc-late": 273435,
            "nwicu": 0,
        },
        "variables": [
            "age",
            "anti_coag_ind",
            "cf_treat_ind",
            "diur_ind",
            "fio2",
            "ins_ind",
            "map",
            "mgcs",
            "o2sat",
            "pco2",
            "peak",
            "peep",
            "pf_ratio",
            "po2",
            "resp",
            "sed_ind",
            "sex",
            "supp_o2_vent",
            "temp",
            "tgcs",
            # "airway_ind",
        ],
    },
    "circulatory_failure_at_8h": {
        "task": "classification",
        "family": "binomial",
        "alpha_max": 0.25,
        "n_samples": {
            "mimic": 270080,
            "ehrshot": 14266,
            "miived": 0,
            "miiv": 565139,
            "eicu": 287585,
            "hirid": 606160,
            "aumc": 217223,
            "sic": 1105034,
            "zigong": 1963,
            "picdb": 0,
            "mimic-metavision": 123609,
            "mimic-carevue": 144977,
            "miiv-late": 303327,
            "aumc-early": 40541,
            "aumc-late": 176682,
            "nwicu": 43563,
        },
        "variables": [
            "age",
            "cf_treat_ind",
            "cout",
            "crp",
            "dbp",
            "glu",
            "hr",
            "inr_pt",
            "lact",
            "map",
            "nonop_pain_ind",
            "o2sat",
            "peak",
            "rass",
            "sbp",
            "supp_o2_vent",
        ],
    },
    "kidney_failure_at_48h": {
        "task": "classification",
        "family": "binomial",
        "alpha_max": 0.15,
        "n_samples": {
            "mimic": 2961026,
            "ehrshot": 62150,
            "miived": 0,
            "miiv": 5279681,
            "eicu": 5668932,
            "hirid": 980458,
            "aumc": 1487426,
            "sic": 1367201,
            "zigong": 0,
            "picdb": 0,
            "mimic-metavision": 1313601,
            "mimic-carevue": 1632587,
            "miiv-late": 2694756,
            "aumc-early": 701300,
            "aumc-late": 786126,
            "nwicu": 29505,
        },
        "variables": [
            "abx_ind",
            # "airway_ind",
            "anti_coag_ind",
            "anti_delir_ind",
            "bili",
            "cf_treat_ind",
            "crea",
            "crp",
            "diur_ind",
            "fluid_ind",
            "inf_rbc_ind",
            "k",
            "mg",
            "pain_killer_ind",
            "rel_urine_rate",
            "resp",
            "ufilt_ind",
            "weight",
        ],
    },
    "log_creatine_in_1h": {
        "task": "regression",
        "family": "gaussian",
        "n_samples": {
            "mimic": 278792,
            "ehrshot": 70821,
            "miived": 0,
            "miiv": 500728,
            "eicu": 604236,
            "hirid": 69649,
            "aumc": 109604,
            "sic": 92011,
            "zigong": 9951,
            "picdb": 0,
            "mimic-metavision": 118577,
            "mimic-carevue": 157241,
            "miiv-late": 256965,
            "aumc-early": 53878,
            "aumc-late": 55726,
            "nwicu": 146530,
        },
        "alpha_max": 0.53,
    },
    "log_lactate_in_1h": {
        "task": "regression",
        "family": "gaussian",
        "n_samples": {
            "mimic": 111135,
            "ehrshot": 10809,
            "miived": 0,
            "miiv": 270623,
            "eicu": 116096,
            "hirid": 205320,
            "aumc": 114515,
            "sic": 489852,
            "zigong": 10976,
            "picdb": 0,
            "mimic-metavision": 52425,
            "mimic-carevue": 57445,
            "miiv-late": 149767,
            "aumc-early": 21505,
            "aumc-late": 93010,
            "nwicu": 47710,
        },
        "alpha_max": 0.54,
    },
    "log_lactate_in_8h": {
        "task": "regression",
        "family": "gaussian",
        "n_samples": {
            "mimic": 87361,
            "mimic-metavision": 40473,
            "mimic-carevue": 45856,
            "miived": 0,
            "miiv": 207861,
            "miiv-late": 115751,
            "eicu": 81666,
            "hirid": 165926,
            "aumc": 95121,
            "aumc-early": 17338,
            "aumc-late": 77783,
            "sic": 419345,
            "zigong": 9248,
            "picdb": 0,
            "nwicu": 38984,
        },
        "alpha_max": 0.46,
    },
    "log_rel_urine_rate_in_1h": {
        "task": "regression",
        "family": "gaussian",
        "n_samples": {
            "mimic": 2513691,
            "mimic-metavision": 1071446,
            "mimic-carevue": 1429682,
            "miived": 0,
            "miiv": 3647178,
            "miiv-late": 1702075,
            "eicu": 2942815,
            "hirid": 434608,
            "aumc": 1164204,
            "aumc-early": 562179,
            "aumc-late": 602025,
            "sic": 1417030,
            "zigong": 0,
            "picdb": 0,
            "nwicu": 0,
        },
        "alpha_max": 0.8,
    },
    "log_rel_urine_rate_in_8h": {
        "task": "regression",
        "family": "gaussian",
        "n_samples": {
            "mimic": 2337842,
            "mimic-metavision": 985846,
            "mimic-carevue": 1339860,
            "miived": 0,
            "miiv": 3341223,
            "miiv-late": 1565769,
            "eicu": 2648121,
            "hirid": 384372,
            "aumc": 1059385,
            "aumc-early": 517004,
            "aumc-late": 542381,
            "sic": 1313309,
            "zigong": 0,
            "picdb": 0,
            "nwicu": 0,
        },
        "alpha_max": 0.8,
    },
}
